// render.nh - Colors and dungeon rendering

// ============================================================================
// Display Constants
// ============================================================================

TILE_W := 10.
TILE_H := 16.

// Tile characters
CHAR_FLOOR := 46.       // '.'
CHAR_WALL_H := 45.      // '-'
CHAR_WALL_V := 124.     // '|'
CHAR_PLAYER := 64.      // '@'
CHAR_DOOR := 43.        // '+'
CHAR_CORRIDOR := 35.    // '#'
CHAR_STAIRS_DOWN := 62. // '>'
CHAR_GOLD := 36.        // '$'

// ============================================================================
// Colors
// ============================================================================

COL_GRAY_R := 170.
COL_GRAY_G := 170.
COL_GRAY_B := 170.

COL_WHITE_R := 255.
COL_WHITE_G := 255.
COL_WHITE_B := 255.

COL_GOLD_R := 255.
COL_GOLD_G := 255.
COL_GOLD_B := 0.

COL_BROWN_R := 180.
COL_BROWN_G := 100.
COL_BROWN_B := 40.

COL_CYAN_R := 0.
COL_CYAN_G := 255.
COL_CYAN_B := 255.

COL_GREEN_R := 100.
COL_GREEN_G := 255.
COL_GREEN_B := 100.

// ============================================================================
// Dungeon Rendering
// ============================================================================

#render_dungeon() >
    map_offset_x := dungeon_x.
    map_offset_y := dungeon_y + 12.
    
    // Draw tiles
    for y in 0..MAP_HEIGHT >
        for x in 0..MAP_WIDTH >
            /draw_tile/x/y/map_offset_x/map_offset_y.
        <
    <
    
    // Draw player with interpolated position for smooth movement
    t_ms := anim_duration_scaled - anim_timer.
    t_ms = 0 when t_ms lt 0.
    
    prev_px := player_prev_x * TILE_W.
    curr_px := player_x * TILE_W.
    prev_py := player_prev_y * TILE_H.
    curr_py := player_y * TILE_H.
    
    // Calculate interpolated position
    draw_x := curr_px.
    draw_y := curr_py.
    draw_x = prev_px + (curr_px - prev_px) * t_ms / anim_duration_scaled when anim_duration_scaled gt 0.
    draw_y = prev_py + (curr_py - prev_py) * t_ms / anim_duration_scaled when anim_duration_scaled gt 0.
    
    px := map_offset_x + draw_x.
    py := map_offset_y + draw_y.
    /text_char/px/py/TILE_H/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/CHAR_PLAYER.
    
    // Status
    /draw_status/map_offset_x/map_offset_y.
    
    // Message
    msg_y := map_offset_y + MAP_HEIGHT * TILE_H + 60.
    /text_draw/map_offset_x/msg_y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/last_message.
    
    // Show print value below message (yellow color: 255, 220, 80)
    /text_draw/(map_offset_x)/(msg_y + 20)/12/255/220/80/"Print:" when bot_has_print == 1.
    /text_draw_int/(map_offset_x + 55)/(msg_y + 20)/12/255/220/80/bot_print_buffer when bot_has_print == 1.
    
    // Header
    /text_draw/map_offset_x/dungeon_y/12/COL_CYAN_R/COL_CYAN_G/COL_CYAN_B/"[DUNGEON]".
    
    // Bot status
    bot_x := map_offset_x + 100.
    /text_draw/bot_x/dungeon_y/12/COL_GREEN_R/COL_GREEN_G/COL_GREEN_B/"BOT: RUNNING" when bot_is_running == 1 and bot_has_error == 0.
    /text_draw/bot_x/dungeon_y/12/COL_GRAY_R/COL_GRAY_G/COL_GRAY_B/"BOT: STOPPED" when bot_is_running == 0 and bot_has_error == 0.
    /text_draw/bot_x/dungeon_y/12/255/80/80/"BOT: ERROR" when bot_has_error == 1.
    
    // Step counter
    step_x := map_offset_x + 220.
    /text_draw/step_x/dungeon_y/12/COL_CYAN_R/COL_CYAN_G/COL_CYAN_B/"Step:".
    /text_draw_int/(step_x + 45)/dungeon_y/12/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/bot_step_count.
<

#draw_tile(x, y, offset_x, offset_y) >
    tile := /get_tile/x/y.
    << 0 when tile == TILE_EMPTY.
    
    sx := offset_x + x * TILE_W.
    sy := offset_y + y * TILE_H.
    
    /text_char/sx/sy/TILE_H/COL_GRAY_R/COL_GRAY_G/COL_GRAY_B/CHAR_FLOOR when tile == TILE_FLOOR.
    /text_char/sx/sy/TILE_H/COL_BROWN_R/COL_BROWN_G/COL_BROWN_B/CHAR_WALL_H when tile == TILE_WALL_H.
    /text_char/sx/sy/TILE_H/COL_BROWN_R/COL_BROWN_G/COL_BROWN_B/CHAR_WALL_V when tile == TILE_WALL_V.
    /text_char/sx/sy/TILE_H/COL_GRAY_R/COL_GRAY_G/COL_GRAY_B/CHAR_CORRIDOR when tile == TILE_CORRIDOR.
    /text_char/sx/sy/TILE_H/COL_BROWN_R/COL_BROWN_G/COL_BROWN_B/CHAR_DOOR when tile == TILE_DOOR.
    /text_char/sx/sy/TILE_H/COL_CYAN_R/COL_CYAN_G/COL_CYAN_B/CHAR_STAIRS_DOWN when tile == TILE_STAIRS.
    /text_char/sx/sy/TILE_H/COL_GOLD_R/COL_GOLD_G/COL_GOLD_B/CHAR_GOLD when tile == TILE_GOLD.
<

#draw_status(offset_x, offset_y) >
    y := offset_y + MAP_HEIGHT * TILE_H + 10.
    
    // LINE 1
    // Wizard the Candidate             St:18/03 Dx:13 Co:8 In:9 Wi:15 Ch:9  Chaotic
    
    // Name + Rank
    x := offset_x.
    /text_draw/x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_name.
    
    x = x + /ds_strlen/player_name * 9 + 10.
    /text_draw/x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"the".
    
    x = x + 35.
    /text_draw/x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_rank.
    
    // Attributes starting around x=300?
    attr_x := offset_x + 350.
    
    // St:18/03
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"St:".
    /text_draw_int/(attr_x + 25)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_str.
    /text_draw/(attr_x + 45)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"/".
    // 03 padding
    val := player_str_exc.
    /text_draw/(attr_x + 55)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"0" when val lt 10.
    draw_val_x := attr_x + 55.
    draw_val_x = attr_x + 65 when val lt 10.
    /text_draw_int/draw_val_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/val.
    
    // Dx:13
    attr_x = attr_x + 90.
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Dx:".
    /text_draw_int/(attr_x + 25)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_dex.
    
    // Co:8
    attr_x = attr_x + 60.
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Co:".
    /text_draw_int/(attr_x + 25)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_con.
    
    // In:9
    attr_x = attr_x + 50.
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"In:".
    /text_draw_int/(attr_x + 25)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_int.
    
    // Wi:15
    attr_x = attr_x + 50.
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Wi:".
    /text_draw_int/(attr_x + 25)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_wis.
    
    // Ch:9
    attr_x = attr_x + 60.
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Ch:".
    /text_draw_int/(attr_x + 25)/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_cha.
    
    // Align
    attr_x = attr_x + 60.
    /text_draw/attr_x/y/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_align.
    
    
    // LINE 2
    // Dlvl:1  $:43  HP:11(14) Pw:4(5) AC:4  Xp:1/5 T:7 Conf
    y2 := y + 20.
    x2 := offset_x.
    
    // Dlvl:1
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Dlvl:".
    /text_draw_int/(x2 + 40)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/dungeon_level.
    
    // $:43
    x2 = x2 + 80.
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"$:".
    /text_draw_int/(x2 + 20)/y2/14/COL_GOLD_R/COL_GOLD_G/COL_GOLD_B/player_gold.
    
    // HP:11(14)
    x2 = x2 + 80.
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"HP:".
    /text_draw_int/(x2 + 30)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_hp.
    
    hp_width := 15. // Approx
    hp_width = 25 when player_hp gt 9.
    
    x_brack := x2 + 30 + hp_width.
    /text_draw/x_brack/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"(".
    /text_draw_int/(x_brack + 10)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_max_hp.
    
    hp_max_width := 15.
    hp_max_width = 25 when player_max_hp gt 9.
    
    /text_draw/(x_brack + 10 + hp_max_width)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/")".
    
    // Pw:4(5)
    x2 = x2 + 130.
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Pw:".
    /text_draw_int/(x2 + 30)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_pw.
    
    pw_width := 10.
    pw_width = 20 when player_pw gt 9.
    
    x_brack_pw := x2 + 30 + pw_width.
    /text_draw/x_brack_pw/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"(".
    /text_draw_int/(x_brack_pw + 10)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_max_pw.
    
    pw_max_width := 10.
    pw_max_width = 20 when player_max_pw gt 9.
    
    /text_draw/(x_brack_pw + 10 + pw_max_width)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/")".
    
    // AC:4
    x2 = x2 + 110.
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"AC:".
    /text_draw_int/(x2 + 30)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_ac.
    
    // Xp:1/5
    x2 = x2 + 70.
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"Xp:".
    /text_draw_int/(x2 + 30)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_xp_level.
    
    xp_width := 10.
    xp_width = 20 when player_xp_level gt 9.
    
    /text_draw/(x2 + 30 + xp_width)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"/".
    /text_draw_int/(x2 + 40 + xp_width)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/player_xp_points.
    
    // T:7
    x2 = x2 + 100.
    /text_draw/x2/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/"T:".
    /text_draw_int/(x2 + 20)/y2/14/COL_WHITE_R/COL_WHITE_G/COL_WHITE_B/turns.
    
    // Conf / Status
    x2 = x2 + 80.
    /text_draw/x2/y2/14/255/100/100/player_status_str.
<


COL_RED_R := 255.
COL_RED_G := 80.
COL_RED_B := 80.

#draw_entities() >
    map_offset_x := dungeon_x.
    map_offset_y := dungeon_y + 12.
    
    for i in 0..MAX_ENTITIES >
        active := entity_active[i].
        // Only process active
        skip := 0.
        skip = 1 when active == 0.
        
        // Draw if active
        // Use loop guard trick or just if check inside? 
        // We can just execute if active check passes
        
        ex := entity_x[i].
        ey := entity_y[i].
        etype := entity_type[i].
        
        sx := map_offset_x + ex * TILE_W.
        sy := map_offset_y + ey * TILE_H.
        
        // Color selection
        r := COL_RED_R.
        g := COL_RED_G.
        b := COL_RED_B.
        
        // Green for goblins?
        is_goblin := 0.
        is_goblin = 1 when etype == 103. // 'g'
        
        r = COL_GREEN_R when is_goblin == 1.
        g = COL_GREEN_G when is_goblin == 1.
        b = COL_GREEN_B when is_goblin == 1.
        
        /text_char/sx/sy/TILE_H/r/g/b/etype when active == 1.
    <
<
